@page
@model Sistema_de_Gestion_de_Proyectos_y_Tareas.Pages.Configuracion.CambiarPasswordModel
@{
    ViewData["Title"] = "Cambiar Contraseña";
    var requiereCambio = User.FindFirst("RequiereCambioContraseña")?.Value == "True";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>
    :root {
        --volcanic-bg: #1e1e2d;
        --volcanic-card: #2d2d3b;
        --accent-orange: #FF5722;
        --accent-red: #D32F2F;
        --accent-gold: #FFC107;
        --accent-green: #4CAF50;
        --text-primary: #f5f5f7;
        --text-secondary: #a0a0a0;
    }

    body {
        background-color: var(--volcanic-bg);
        color: var(--text-primary);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .title-volcanic {
        background: linear-gradient(to right, #FF512F, #F09819);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 800;
        margin-bottom: 2rem;
        font-size: 2rem;
    }

    .security-card {
        background-color: var(--volcanic-card);
        border-radius: 16px;
        padding: 2.5rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.05);
        max-width: 600px;
        margin: 0 auto;
    }

    .form-label {
        color: #ddd;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .input-group-text {
        background-color: #1a1a20;
        border: 1px solid #444;
        border-right: none;
        color: #888;
    }

    .form-control {
        background-color: #1a1a20;
        color: #fff;
        border: 1px solid #444;
        border-left: none;
        padding: 0.8rem 1rem;
        transition: 0.3s;
    }

        .form-control:focus {
            background-color: #222;
            border-color: var(--accent-orange);
            box-shadow: none;
            color: #fff;
        }

            .form-control:focus + .input-group-text,
            .input-group-text:has(+ .form-control:focus) {
                border-color: var(--accent-orange);
                color: var(--accent-orange);
            }

    .btn-toggle-pass {
        background-color: #1a1a20;
        border: 1px solid #444;
        border-left: none;
        color: #888;
        cursor: pointer;
        z-index: 5;
    }

        .btn-toggle-pass:hover {
            color: #fff;
        }

    .strength-meter {
        height: 6px;
        background-color: #444;
        border-radius: 3px;
        margin-top: 10px;
        overflow: hidden;
        transition: 0.3s;
    }

    .strength-bar {
        height: 100%;
        width: 0%;
        transition: width 0.3s ease, background-color 0.3s ease;
    }

    .requirements-list {
        list-style: none;
        padding: 0;
        margin-top: 15px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
    }

    .req-item {
        font-size: 0.8rem;
        color: #666;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: 0.3s;
    }

        .req-item i {
            font-size: 1rem;
        }

        .req-item.valid {
            color: var(--accent-green);
        }

        .req-item.invalid {
            color: #666;
        }

    .btn-volcanic-primary {
        background: linear-gradient(135deg, #FF512F 0%, #DD2476 100%);
        border: none;
        color: white;
        font-weight: bold;
        padding: 12px 30px;
        border-radius: 50px;
        width: 100%;
        margin-top: 1.5rem;
        transition: 0.3s;
    }

        .btn-volcanic-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(221, 36, 118, 0.4);
            color: white;
        }

    .alert-custom {
        border-radius: 10px;
        font-size: 0.9rem;
        border: none;
    }

    .alert-warning {
        background: rgba(255, 193, 7, 0.15);
        color: #FFC107;
        border-left: 4px solid #FFC107;
    }

    .alert-success {
        background: rgba(76, 175, 80, 0.15);
        color: #4CAF50;
        border-left: 4px solid #4CAF50;
    }

    .alert-danger {
        background: rgba(244, 67, 54, 0.15);
        color: #ff5252;
        border-left: 4px solid #ff5252;
    }

    .validation-msg {
        font-size: 0.8rem;
        color: #ff5252;
        margin-top: 4px;
    }
</style>

<div class="container mt-4">
    <div class="text-center">
        <h1 class="title-volcanic">@ViewData["Title"]</h1>
        <p class="text-muted mb-4">Mantén tu cuenta segura actualizando tu contraseña periódicamente.</p>
    </div>

    @if (requiereCambio)
    {
    <div class="alert alert-warning mb-4 mx-auto" style="max-width: 600px;">
        <h5><i class="bi bi-shield-lock-fill"></i> Cambio Requerido</h5>
        <p class="mb-0">Estás usando una contraseña temporal. Por seguridad, debes crear una nueva contraseña personalizada.</p>
    </div>
    }

    @if (!string.IsNullOrEmpty(TempData["MensajeExito"] as string))
    {
    <div class="alert alert-success alert-dismissible fade show mx-auto" style="max-width: 600px;" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i> @TempData["MensajeExito"]
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
    </div>
    }

    @if (!string.IsNullOrEmpty(TempData["MensajeError"] as string))
    {
    <div class="alert alert-danger alert-dismissible fade show mx-auto" style="max-width: 600px;" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i> @TempData["MensajeError"]
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
    </div>
    }

    <div class="security-card">
        <form method="post" id="cambiarPasswordForm">
            <div asp-validation-summary="ModelOnly" class="text-danger mb-3 small"></div>

            <div class="mb-4">
                <label asp-for="Input.ContraseñaActual" class="form-label">Contraseña Actual</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-key"></i></span>
                    <input asp-for="Input.ContraseñaActual" class="form-control" type="password" id="currentPass" placeholder="••••••••" />
                    <button class="btn btn-toggle-pass" type="button" onclick="togglePassword('currentPass', this)">
                        <i class="bi bi-eye"></i>
                    </button>
                </div>
                <span asp-validation-for="Input.ContraseñaActual" class="validation-msg"></span>
            </div>

            <hr style="border-color: rgba(255,255,255,0.1); margin: 2rem 0;">

            <div class="mb-3">
                <label asp-for="Input.NuevaContraseña" class="form-label">Nueva Contraseña</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-lock"></i></span>
                    <input asp-for="Input.NuevaContraseña" class="form-control" type="password" id="newPass" placeholder="Crear nueva contraseña" oninput="validatePassword()" />
                    <button class="btn btn-toggle-pass" type="button" onclick="togglePassword('newPass', this)">
                        <i class="bi bi-eye"></i>
                    </button>
                </div>

                <div class="strength-meter">
                    <div class="strength-bar" id="strengthBar"></div>
                </div>
                <div id="strengthText" style="font-size: 0.75rem; text-align: right; margin-top: 2px; color: #666;">Fuerza: Baja</div>

                <ul class="requirements-list">
                    <li class="req-item" id="req-length"><i class="bi bi-circle"></i> 8-15 caracteres</li>
                    <li class="req-item" id="req-upper"><i class="bi bi-circle"></i> Mayúscula (A-Z)</li>
                    <li class="req-item" id="req-lower"><i class="bi bi-circle"></i> Minúscula (a-z)</li>
                    <li class="req-item" id="req-num"><i class="bi bi-circle"></i> Número (0-9)</li>
                    <li class="req-item" id="req-spec"><i class="bi bi-circle"></i> Símbolo (#, $, %, etc.)</li>
                </ul>

                <span asp-validation-for="Input.NuevaContraseña" class="validation-msg"></span>
            </div>

            <div class="mb-4">
                <label asp-for="Input.ConfirmarContraseña" class="form-label">Confirmar Contraseña</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-check2-circle"></i></span>
                    <input asp-for="Input.ConfirmarContraseña" class="form-control" type="password" id="confirmPass" placeholder="Repite la contraseña" oninput="checkMatch()" />
                    <button class="btn btn-toggle-pass" type="button" onclick="togglePassword('confirmPass', this)">
                        <i class="bi bi-eye"></i>
                    </button>
                </div>
                <div id="matchFeedback" style="font-size: 0.8rem; margin-top: 5px; display: none;">
                    <i class="bi bi-x-circle"></i> No coinciden
                </div>
                <span asp-validation-for="Input.ConfirmarContraseña" class="validation-msg"></span>
            </div>

            <button type="submit" class="btn btn-volcanic-primary">
                Actualizar Contraseña
            </button>

            <div class="text-center mt-3">
                <a asp-page="/Index" style="color: #888; text-decoration: none; font-size: 0.9rem;">Cancelar y Volver</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); }

    <script>
        function togglePassword(inputId, btn) {
            const input = document.getElementById(inputId);
            const icon = btn.querySelector('i');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
                icon.style.color = 'var(--accent-orange)';
            } else {
                input.type = 'password';
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
                icon.style.color = '';
            }
        }

        function validatePassword() {
            const password = document.getElementById('newPass').value;

            const hasLength = password.length >= 8 && password.length <= 15;
            const hasUpper = /[A-Z]/.test(password);
            const hasLower = /[a-z]/.test(password);
            const hasNum = /\d/.test(password);
            const hasSpec = /[\W_]/.test(password);

            updateReq('req-length', hasLength);
            updateReq('req-upper', hasUpper);
            updateReq('req-lower', hasLower);
            updateReq('req-num', hasNum);
            updateReq('req-spec', hasSpec);

            const strength = [hasLength, hasUpper, hasLower, hasNum, hasSpec].filter(Boolean).length;
            const bar = document.getElementById('strengthBar');
            const text = document.getElementById('strengthText');

            let width = (strength / 5) * 100;
            bar.style.width = width + '%';

            if (strength <= 2) {
                bar.style.backgroundColor = '#D32F2F'; 
                text.textContent = 'Fuerza: Débil';
                text.style.color = '#D32F2F';
            } else if (strength <= 4) {
                bar.style.backgroundColor = '#FFC107'; 
                text.textContent = 'Fuerza: Media';
                text.style.color = '#FFC107';
            } else {
                bar.style.backgroundColor = '#4CAF50'; 
                text.textContent = 'Fuerza: Segura';
                text.style.color = '#4CAF50';
            }

            checkMatch(); 
        }

        function updateReq(id, valid) {
            const el = document.getElementById(id);
            const icon = el.querySelector('i');

            if (valid) {
                el.classList.add('valid');
                el.classList.remove('invalid');
                icon.classList.remove('bi-circle');
                icon.classList.add('bi-check-circle-fill');
            } else {
                el.classList.remove('valid');
                el.classList.add('invalid');
                icon.classList.remove('bi-check-circle-fill');
                icon.classList.add('bi-circle');
            }
        }

        function checkMatch() {
            const pass = document.getElementById('newPass').value;
            const confirm = document.getElementById('confirmPass').value;
            const feedback = document.getElementById('matchFeedback');

            if (confirm.length > 0) {
                feedback.style.display = 'block';
                if (pass === confirm) {
                    feedback.innerHTML = '<i class="bi bi-check-circle-fill"></i> Las contraseñas coinciden';
                    feedback.style.color = '#4CAF50';
                } else {
                    feedback.innerHTML = '<i class="bi bi-x-circle-fill"></i> Las contraseñas no coinciden';
                    feedback.style.color = '#D32F2F';
                }
            } else {
                feedback.style.display = 'none';
            }
        }
    </script>
}