@page
@model Sistema_de_Gestion_de_Proyectos_y_Tareas.Pages.Tareas.CreateModel
@{
    ViewData["Title"] = "Crear Tarea";
}

<style>
    :root {
        --volcanic-bg: #1e1e2d;
        --volcanic-card: #2d2d3b;
        --accent-orange: #FF5722;
        --text-primary: #f5f5f7;
    }

    body {
        background-color: var(--volcanic-bg);
        color: var(--text-primary);
    }

    .title-volcanic {
        background: linear-gradient(to right, #FF512F, #F09819);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 800;
        margin-bottom: 2rem;
    }

    .form-container {
        background-color: var(--volcanic-card);
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.05);
    }

    .form-control, .form-select, .search-input {
        background-color: #1a1a20;
        color: var(--text-primary);
        border: 1px solid #444;
        border-radius: 8px;
        padding: 0.75rem 1rem;
    }

        .form-control:focus, .form-select:focus, .search-input:focus {
            background-color: #222;
            color: #fff;
            border-color: var(--accent-orange);
            box-shadow: 0 0 0 0.25rem rgba(255, 87, 34, 0.2);
            outline: none;
        }

    .form-label {
        color: #cfcfcf;
        font-weight: 500;
        margin-bottom: 0.5rem;
    }

    .text-danger {
        color: #ff5252 !important;
        font-weight: 500;
        font-size: 0.85rem;
    }

    .btn-volcanic-primary {
        background: linear-gradient(135deg, #FF512F 0%, #DD2476 100%);
        border: none;
        color: white;
        font-weight: bold;
        padding: 12px 30px;
        border-radius: 50px;
        transition: all 0.3s ease;
    }

        .btn-volcanic-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(221, 36, 118, 0.4);
        }

    .btn-volcanic-secondary {
        background: transparent;
        border: 2px solid #555;
        color: #aaa;
        padding: 10px 25px;
        border-radius: 50px;
    }

        .btn-volcanic-secondary:hover {
            border-color: #fff;
            color: #fff;
        }

    .proyecto-list-container {
        background-color: #1a1a20;
        border: 1px solid #444;
        border-radius: 8px;
        max-height: 200px;
        overflow-y: auto;
        margin-top: 5px;
    }

    .proyecto-option {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #333;
        color: #ccc;
    }

        .proyecto-option:hover {
            background-color: #333;
            color: var(--accent-orange);
        }

        .proyecto-option.selected-proyecto {
            background-color: rgba(255, 87, 34, 0.1);
            border-left: 3px solid var(--accent-orange);
            color: #fff;
        }

        .proyecto-option.hidden {
            display: none;
        }
</style>

<h1 class="title-volcanic">@ViewData["Title"]</h1>

<div class="row justify-content-center justify-content-md-start">
    <div class="col-lg-8">
        <div class="form-container">
            <form method="post" id="createTareaForm">
                <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                <div class="mb-4">
                    <label asp-for="Tarea.Titulo" class="form-label">Título de la Tarea</label>
                    <input asp-for="Tarea.Titulo" class="form-control" placeholder="Ej: Implementar Login Volcánico" />
                    <span asp-validation-for="Tarea.Titulo" class="text-danger"></span>
                </div>

                <div class="mb-4">
                    <label asp-for="Tarea.Descripcion" class="form-label">Descripción</label>
                    <textarea asp-for="Tarea.Descripcion" class="form-control" rows="4" placeholder="Detalles técnicos..."></textarea>
                    <span asp-validation-for="Tarea.Descripcion" class="text-danger"></span>
                </div>

                <div class="mb-4">
                    <label asp-for="Tarea.Prioridad" class="form-label">Nivel de Prioridad</label>
                    <select asp-for="Tarea.Prioridad" class="form-select">
                        <option value="Alta">🔥 Alta</option>
                        <option value="Media" selected>⚡ Media</option>
                        <option value="Baja">🌱 Baja</option>
                    </select>
                    <span asp-validation-for="Tarea.Prioridad" class="text-danger"></span>
                </div>

                <div class="mb-4">
                    <label class="form-label">Asignar a Proyecto</label>
                    <div class="position-relative">
                        <input type="text" id="proyectoSearch" class="search-input" placeholder="🔍 Buscar proyecto..." autocomplete="off" />
                    </div>

                    <div id="proyectosList" class="proyecto-list-container">
                        @foreach (var proyecto in Model.ProyectosDisponibles)
                        {
                        <div class="proyecto-option"
                             data-id="@proyecto.IdProyecto"
                             data-nombre="@proyecto.Nombre.ToLower()"
                             onclick="selectProyecto(@proyecto.IdProyecto, '@proyecto.Nombre'.replaceAll('\'', '\\\''))">
                            @proyecto.Nombre
                        </div>
                        }
                        <div id="noResultsProyecto" class="p-3 text-center text-muted" style="display: none;">
                            No se encontraron proyectos
                        </div>
                    </div>

                    <input type="hidden" asp-for="Tarea.IdProyecto" id="proyectoIdInput" />
                    <span asp-validation-for="Tarea.IdProyecto" class="text-danger"></span>

                    <div class="mt-2 text-end">
                        <small class="text-muted">Proyecto seleccionado:</small>
                        <span id="selectedProyectoName" style="color: var(--accent-orange); font-weight:bold;">Ninguno</span>
                    </div>
                </div>

                <input type="hidden" asp-for="Tarea.Status" value="SinIniciar" />

                <div class="alert mt-3" style="background: rgba(33, 150, 243, 0.1); border-left: 4px solid #2196F3; color: #90caf9;">
                    <i class="bi bi-info-circle-fill me-2"></i> La tarea iniciará con estado <strong>"Sin Iniciar"</strong>.
                </div>

                <div class="mt-4 pt-3 border-top border-secondary">
                    <button type="submit" class="btn btn-volcanic-primary">
                        <i class="bi bi-check-lg"></i> Guardar Tarea
                    </button>
                    <a asp-page="Index" class="btn btn-volcanic-secondary ms-2">Cancelar</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); }
    <script>
        setupFormConfirmation('createTareaForm', 'confirmCreate');

        const searchInput = document.getElementById('proyectoSearch');
        const proyectoOptions = document.querySelectorAll('.proyecto-option');
        const noResults = document.getElementById('noResultsProyecto');
        const proyectoIdInput = document.getElementById('proyectoIdInput');
        const selectedProyectoName = document.getElementById('selectedProyectoName');

        searchInput.addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase().trim();
            let visibleCount = 0;

            proyectoOptions.forEach(function (option) {
                const nombre = option.getAttribute('data-nombre');
                if (nombre.includes(searchTerm) || searchTerm === '') {
                    option.classList.remove('hidden');
                    visibleCount++;
                } else {
                    option.classList.add('hidden');
                }
            });

            noResults.style.display = (visibleCount === 0 && searchTerm !== '') ? 'block' : 'none';
        });

        function selectProyecto(id, nombre) {
            proyectoIdInput.value = id;
            selectedProyectoName.textContent = nombre;
            proyectoOptions.forEach(opt => opt.classList.remove('selected-proyecto'));
            document.querySelector(`[data-id="${id}"]`).classList.add('selected-proyecto');
        }

        document.addEventListener('DOMContentLoaded', function () {
            if (proyectoOptions.length > 0) {
                const first = proyectoOptions[0];
                selectProyecto(first.getAttribute('data-id'), first.textContent.trim());
            }
        });
    </script>
}