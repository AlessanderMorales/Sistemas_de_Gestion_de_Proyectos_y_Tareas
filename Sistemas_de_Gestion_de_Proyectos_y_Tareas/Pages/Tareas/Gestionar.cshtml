@page
@model Sistema_de_Gestion_de_Proyectos_y_Tareas.Pages.Tareas.GestionarModel
@{
    ViewData["Title"] = "Asignación y Reportes";
}

@section Styles {
    <link rel="stylesheet" href="~/css/gestionar.css" asp-append-version="true" />
}

<style>
    :root {
        --volcanic-bg: #1e1e2d;
        --volcanic-card: #2d2d3b;
        --volcanic-darker: #15151a;
        --accent-red: #D32F2F;
        --accent-orange: #FF5722;
        --accent-gold: #FFD700;
        --accent-lava: linear-gradient(135deg, #FF512F 0%, #DD2476 100%);
        --text-primary: #f5f5f7;
        --border-color: rgba(255,255,255,0.1);
    }

    body {
        background-color: var(--volcanic-bg);
        color: var(--text-primary);
    }

    .title-volcanic {
        background: linear-gradient(to right, #FF512F, #F09819);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 800;
        border-bottom: 2px solid rgba(255, 87, 34, 0.3);
        padding-bottom: 0.5rem;
        margin-bottom: 2rem;
    }

    .section-card {
        background-color: var(--volcanic-card);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        animation: fadeIn 0.5s ease-out;
    }

    .section-title {
        color: var(--accent-orange);
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .search-input {
        background-color: #1a1a20;
        color: var(--text-primary);
        border: 1px solid #444;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        width: 100%;
        transition: all 0.3s ease;
        margin-bottom: 0.5rem;
    }

        .search-input:focus {
            background-color: #222;
            border-color: var(--accent-orange);
            box-shadow: 0 0 0 0.25rem rgba(255, 87, 34, 0.2);
            outline: none;
        }

        .search-input:disabled {
            background-color: #121215;
            border-color: #333;
            color: #555;
            cursor: not-allowed;
        }

    .options-list {
        max-height: 250px;
        overflow-y: auto;
        background-color: #1a1a20;
        border-radius: 8px;
        border: 1px solid #444;
        margin-bottom: 1rem;
    }

    .option-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: background-color 0.2s;
        border-bottom: 1px solid #2d2d3b;
        color: #bbb;
        animation: slideIn 0.3s ease-out;
    }

        .option-item:hover {
            background-color: #363645;
            color: white;
        }

        .option-item.hidden {
            display: none;
        }

        .option-item.selected {
            background: linear-gradient(90deg, rgba(255, 87, 34, 0.15), transparent);
            border-left: 4px solid var(--accent-orange);
            color: white;
            font-weight: bold;
        }

    .empleado-checkbox {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background-color: #1a1a20;
        border-bottom: 1px solid #2d2d3b;
        cursor: pointer;
        transition: background-color 0.2s;
        animation: slideIn 0.3s ease-out;
    }

        .empleado-checkbox:hover {
            background-color: #363645;
        }

        .empleado-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent-orange);
        }

        .empleado-checkbox.hidden {
            display: none;
        }

    .selected-info {
        color: var(--accent-gold);
        font-weight: 500;
    }

    .no-results {
        padding: 1rem;
        text-align: center;
        color: #888;
        font-style: italic;
    }

    .btn-volcanic-primary {
        background: var(--accent-lava);
        border: none;
        color: white;
        font-weight: bold;
        padding: 12px 25px;
        border-radius: 8px;
        transition: all 0.3s ease;
        width: 100%;
        margin-top: 1rem;
    }

        .btn-volcanic-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(221, 36, 118, 0.4);
        }

        .btn-volcanic-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            background: #444;
        }

    .btn-create-tarea {
        background: transparent;
        border: 1px solid var(--accent-gold);
        color: var(--accent-gold);
        font-weight: bold;
        padding: 5px 15px;
        border-radius: 50px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }

        .btn-create-tarea:hover {
            background: var(--accent-gold);
            color: #000;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

    .info-panel {
        background-color: var(--volcanic-darker);
        border-radius: 12px;
        padding: 1.5rem;
        border: 1px solid #333;
        height: 100%;
    }

    .info-panel-title {
        color: var(--accent-orange);
        font-size: 1rem;
        font-weight: 700;
        margin-bottom: 1rem;
        text-transform: uppercase;
        border-bottom: 1px solid #333;
        padding-bottom: 0.5rem;
    }

    .empleado-item {
        background-color: #1a1a20;
        padding: 0.75rem 1rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #333;
    }

    .empleado-activo {
        border-left: 3px solid #4CAF50;
    }

    .badge-activo {
        background-color: rgba(76, 175, 80, 0.2);
        color: #4CAF50;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
        border: 1px solid #4CAF50;
        animation: pulse 2s ease-in-out infinite;
    }

    .btn-report {
        background: #2d2d3b;
        border: 1px solid #444;
        color: var(--text-primary);
        font-weight: 500;
        padding: 12px 15px;
        border-radius: 8px;
        transition: all 0.3s ease;
        width: 100%;
        margin-bottom: 0.5rem;
        text-align: left;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .btn-report:hover {
            border-color: var(--accent-orange);
            color: white;
            background: #363645;
        }

        .btn-report span.icon-rotate {
            margin-right: 10px;
        }

    .counter-badge {
        background: var(--accent-lava);
        color: white;
        padding: 0.5rem 1.5rem;
        border-radius: 50px;
        font-size: 1rem;
        font-weight: bold;
        display: inline-block;
        margin-bottom: 1rem;
        box-shadow: 0 4px 10px rgba(221, 36, 118, 0.3);
    }

    .btn-quitar-empleado {
        background-color: rgba(211, 47, 47, 0.1);
        border: 1px solid #D32F2F;
        color: #D32F2F;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: bold;
        margin: 0 auto;
    }

        .btn-quitar-empleado:hover {
            background-color: #D32F2F;
            color: white;
            transform: scale(1.1);
        }

    #tablaEmpleadosSeleccionados table {
        background-color: transparent;
        margin-bottom: 0;
    }

    #tablaEmpleadosSeleccionados th {
        color: var(--accent-orange);
        font-weight: 600;
        padding: 0.75rem;
        border-bottom: 1px solid #444;
    }

    #tablaEmpleadosSeleccionados td {
        color: #ccc;
        padding: 0.75rem;
        border-bottom: 1px solid #333;
        vertical-align: middle;
    }

    #tablaEmpleadosSeleccionados tbody tr:hover {
        background-color: rgba(255,255,255,0.03);
    }

    .alert {
        border-radius: 12px;
        border: none;
        color: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }

    .alert-success {
        background: linear-gradient(135deg, #134E5E, #71B280);
    }

    .alert-danger {
        background: linear-gradient(135deg, #cb2d3e, #ef473a);
    }

    .alert-warning {
        background: linear-gradient(135deg, #ff9966, #ff5e62);
    }

    .alert-info {
        background: linear-gradient(135deg, #2196F3, #1976D2);
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(-10px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @@keyframes pulse {
        0%, 100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.05);
        }
    }

    @@keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .btn-volcanic-primary.loading {
        color: transparent;
        position: relative;
    }

        .btn-volcanic-primary.loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid white;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

    .options-list::-webkit-scrollbar {
        width: 6px;
    }

    .options-list::-webkit-scrollbar-track {
        background: #1a1a20;
    }

    .options-list::-webkit-scrollbar-thumb {
        background: #444;
        border-radius: 4px;
    }

        .options-list::-webkit-scrollbar-thumb:hover {
            background: var(--accent-orange);
        }
</style>

<h1 class="title-volcanic">@ViewData["Title"]</h1>

@if (!string.IsNullOrEmpty(TempData["SuccessMessage"] as string))
{
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <strong><i class="bi bi-check-circle"></i> Éxito:</strong> @TempData["SuccessMessage"]
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

@if (!string.IsNullOrEmpty(TempData["DownloadPdf"] as string) && !string.IsNullOrEmpty(TempData["DownloadExcel"] as string))
    {
<script>
            setTimeout(function() {
                window.location.href = '/Tareas/Gestionar?handler=DescargarReporte&archivo=@TempData["DownloadPdf"]';
                setTimeout(function() {
                    window.location.href = '/Tareas/Gestionar?handler=DescargarReporte&archivo=@TempData["DownloadExcel"]';
                }, 500);
            }, 1000);
</script>
    }
}

@if (!string.IsNullOrEmpty(TempData["ErrorMessage"] as string))
{
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <strong><i class="bi bi-exclamation-triangle"></i> Error:</strong> @TempData["ErrorMessage"]
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
}

@if (!string.IsNullOrEmpty(TempData["WarningMessage"] as string))
{
<div class="alert alert-warning alert-dismissible fade show" role="alert">
    <strong><i class="bi bi-exclamation-circle"></i> Advertencia:</strong> @TempData["WarningMessage"]
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
}

@if (!string.IsNullOrEmpty(TempData["InfoMessage"] as string))
{
<div class="alert alert-info alert-dismissible fade show" role="alert">
    <strong><i class="bi bi-info-circle"></i> Información:</strong> @TempData["InfoMessage"]
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
}

<div class="row">
    <div class="col-lg-8">
        <div class="section-card">
            <div class="section-title">
                <i class="bi bi-folder-fill me-2"></i> Seleccionar Proyecto
            </div>

            <input type="text"
                   id="proyectoSearch"
                   class="search-input"
                   placeholder="🔍 Buscar proyecto..."
                   autocomplete="off">

            <div id="proyectosList" class="options-list">
                @if (Model.Proyectos != null && Model.Proyectos.Any())
                {
                    foreach (var proyecto in Model.Proyectos)
                    {
                <div class="option-item proyecto-option"
                     data-id="@proyecto.IdProyecto"
                     data-nombre="@proyecto.Nombre.ToLower()">
                    @proyecto.Nombre
                </div>
                    }
                }
                else
                {
                <div class="no-results">No hay proyectos disponibles</div>
                }
            </div>

            <small class="text-muted d-block">
                Proyecto seleccionado: <span id="selectedProyectoName" class="selected-info">Ninguno</span>
            </small>
        </div>

        <div class="section-card">
            <div class="section-title d-flex justify-content-between align-items-center">
                <span><i class="bi bi-list-check me-2"></i> Seleccionar Tarea</span>
                <a asp-page="/Tareas/Create" class="btn btn-create-tarea">
                    <i class="bi bi-plus-lg"></i> Nueva Tarea
                </a>
            </div>

            <input type="text"
                   id="tareaSearch"
                   class="search-input"
                   placeholder="🔍 Buscar tarea..."
                   autocomplete="off"
                   disabled>

            <div id="tareasList" class="options-list" style="display: none;">
            </div>

            <div id="noTareasMessage" class="no-results" style="display: none;">
                Selecciona un proyecto primero
            </div>

            <small class="text-muted d-block">
                Tarea seleccionada: <span id="selectedTareaName" class="selected-info">Ninguna</span>
            </small>
        </div>

        <div class="section-card">
            <div class="section-title">
                <i class="bi bi-people-fill me-2"></i> Asignar Empleados
            </div>

            <input type="text"
                   id="empleadoSearch"
                   class="search-input"
                   placeholder="🔍 Buscar empleado..."
                   autocomplete="off"
                   disabled>

            <div id="empleadosList" class="options-list" style="display: none;">
            </div>

            <div id="noEmpleadosMessage" class="no-results">
                Selecciona una tarea primero
            </div>

            <div class="text-center mt-3">
                <div class="counter-badge" id="empleadosSeleccionadosCounter">
                    0 seleccionados
                </div>
            </div>

            <div id="tablaEmpleadosSeleccionados" class="mt-3" style="display: none;">
                <div class="section-title" style="font-size: 0.9rem; margin-bottom: 0.5rem; border:none;">
                    Resumen de Asignación
                </div>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th style="width: 40px; text-align: center;">#</th>
                                <th>Nombre Completo</th>
                                <th>Email</th>
                                <th style="width: 60px; text-align: center;">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="tablaEmpleadosBody">
                        </tbody>
                        <tfoot style="border-top: 1px solid #444;">
                            <tr>
                                <td colspan="3" style="text-align: right; font-weight: bold; color: var(--accent-gold);">
                                    Total:
                                </td>
                                <td style="text-align: center; font-weight: bold; color: var(--accent-gold);" id="totalEmpleadosTabla">
                                    0
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <form method="post" id="asignarForm">
                <input type="hidden" id="tareaIdInput" name="TareaId" />
                <input type="hidden" id="empleadosIdsInput" name="EmpleadosIds" />

                <button type="submit" class="btn btn-volcanic-primary" id="btnAsignar" disabled>
                    <i class="bi bi-save me-2"></i> Guardar Asignaciones
                </button>
            </form>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="info-panel fade-in-up">
            

            <div class="divider my-4" style="border-top: 1px solid #333;"></div>

            <div class="info-panel-title">
                <i class="bi bi-file-earmark-text me-2"></i> Reportes del Sistema
            </div>

            <div class="report-section d-flex flex-column gap-2">
                <button type="button" class="btn btn-report custom-tooltip" onclick="generarReporteCompletoPDF()" data-tooltip="Incluye todos los proyectos y tareas">
                    <span><i class="bi bi-file-pdf-fill text-danger me-2"></i> Sistema Completo (PDF)</span>
                    <i class="bi bi-download"></i>
                </button>
                <button type="button" class="btn btn-report custom-tooltip" onclick="generarReporteCompletoExcel()" data-tooltip="Exportar todo el sistema a Excel">
                    <span><i class="bi bi-file-excel-fill text-success me-2"></i> Sistema Completo (Excel)</span>
                    <i class="bi bi-download"></i>
                </button>
            </div>

            <div class="mt-4 p-3" style="background-color: rgba(33, 150, 243, 0.1); border-radius: 8px; border-left: 3px solid #2196F3;">
                <small style="color: #ccc;">
                    <strong><i class="bi bi-lightbulb"></i> Tip:</strong> Los reportes incluyen información actualizada y datos históricos de asignaciones.
                </small>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
    let proyectoSeleccionado = null;
    let tareaSeleccionada = null;
    let empleadosSeleccionados = [];
    let todasLasTareas = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Tareas ?? new List<Sistema_de_Gestion_de_Proyectos_y_Tareas.DTO.Tareas.TareaDTO>()));
    let todosLosEmpleados = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.EmpleadosDisponibles ?? new List<Sistema_de_Gestion_de_Proyectos_y_Tareas.DTO.Usuarios.UsuarioDTO>()));
    let empleadosAsignados = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.EmpleadosAsignados ?? new Dictionary<int, List<Sistema_de_Gestion_de_Proyectos_y_Tareas.DTO.Usuarios.UsuarioDTO>>()));

    const proyectoSearch = document.getElementById('proyectoSearch');
    const proyectoOptions = document.querySelectorAll('.proyecto-option');

    proyectoOptions.forEach(option => {
        option.addEventListener('click', function() {
            const id = parseInt(this.getAttribute('data-id'));
            const nombre = this.textContent.trim();
            selectProyecto(id, nombre);
        });
    });

    proyectoSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        proyectoOptions.forEach(option => {
            const nombre = option.getAttribute('data-nombre');
            if (nombre.includes(searchTerm) || searchTerm === '') {
                option.classList.remove('hidden');
            } else {
                option.classList.add('hidden');
            }
        });
    });

    function selectProyecto(id, nombre) {
        console.log('Seleccionando proyecto:', id, nombre);

        proyectoSeleccionado = id;
        document.getElementById('selectedProyectoName').textContent = nombre;

        proyectoOptions.forEach(opt => opt.classList.remove('selected'));
        const selectedElement = document.querySelector(`[data-id="${id}"]`);
        if (selectedElement) {
            selectedElement.classList.add('selected');
            agregarEfectoSeleccion(selectedElement);
        }

        tareaSeleccionada = null;
        document.getElementById('selectedTareaName').textContent = 'Ninguna';
        empleadosSeleccionados = [];
        actualizarContador();

        document.getElementById('tareaSearch').disabled = false;

        cargarTareasDelProyecto(id);

        mostrarNotificacion(`Proyecto "${nombre}" seleccionado`, 'info');
    }

    function cargarTareasDelProyecto(idProyecto) {
        const tareasList = document.getElementById('tareasList');
        const noTareasMessage = document.getElementById('noTareasMessage');

        const tareasDelProyecto = todasLasTareas.filter(t => t.idProyecto === idProyecto);

        tareasList.innerHTML = '';

        if (tareasDelProyecto.length === 0) {
            tareasList.style.display = 'none';
            noTareasMessage.textContent = 'No hay tareas en este proyecto';
            noTareasMessage.style.display = 'block';
            return;
        }

        tareasDelProyecto.forEach((tarea, index) => {
            const tareaId = tarea.idTarea;
            const tareaTitulo = tarea.titulo;

            const div = document.createElement('div');
            div.className = 'option-item tarea-option';
            div.setAttribute('data-id', tareaId);
            div.setAttribute('data-titulo', tareaTitulo.toLowerCase());

            div.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const titulo = this.textContent.trim();
                selectTarea(id, titulo);
            });

            div.textContent = tareaTitulo;
            tareasList.appendChild(div);
        });

        tareasList.style.display = 'block';
        noTareasMessage.style.display = 'none';
    }

    const tareaSearch = document.getElementById('tareaSearch');

    tareaSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        const tareaOptions = document.querySelectorAll('.tarea-option');

        tareaOptions.forEach(option => {
            const titulo = option.getAttribute('data-titulo');
            if (titulo.includes(searchTerm) || searchTerm === '') {
                option.classList.remove('hidden');
            } else {
                option.classList.add('hidden');
            }
        });
    });

    function selectTarea(id, titulo) {
        let tareaId = id;
        if (typeof id === 'string') {
            tareaId = parseInt(id, 10);
        }

        if (isNaN(tareaId)) {
            mostrarNotificacion('Error: ID de tarea inválido', 'error');
            return;
        }

        tareaSeleccionada = tareaId;

        document.getElementById('selectedTareaName').textContent = titulo;
        document.getElementById('tareaIdInput').value = tareaSeleccionada;

        sessionStorage.setItem('tareaSeleccionada', tareaSeleccionada.toString());
        sessionStorage.setItem('tareaTitulo', titulo);

        const tareaOptions = document.querySelectorAll('.tarea-option');
        tareaOptions.forEach(opt => opt.classList.remove('selected'));
        const selected = document.querySelector(`.tarea-option[data-id="${tareaSeleccionada}"]`);
        if (selected) {
            selected.classList.add('selected');
            agregarEfectoSeleccion(selected);
        }

        document.getElementById('empleadoSearch').disabled = false;

        cargarEmpleadosDisponibles();
        cargarInformacionTarea(tareaSeleccionada);

        mostrarNotificacion(`Tarea "${titulo}" seleccionada`, 'success');
    }

    function cargarEmpleadosDisponibles() {
        const empleadosList = document.getElementById('empleadosList');
        const noEmpleadosMessage = document.getElementById('noEmpleadosMessage');

        empleadosList.innerHTML = '';
        empleadosSeleccionados = [];

        const empleadosYaAsignados = empleadosAsignados[tareaSeleccionada] || [];
        const idsYaAsignados = empleadosYaAsignados.map(emp =>
            parseInt(emp.id_Usuario || emp.Id || emp.id)
        );

        if (!todosLosEmpleados || todosLosEmpleados.length === 0) {
            empleadosList.style.display = 'none';
            noEmpleadosMessage.textContent = 'No hay empleados disponibles en el sistema';
            noEmpleadosMessage.style.display = 'block';
            return;
        }

        let empleadosMostrados = 0;

        empleadosYaAsignados.forEach(empleado => {
            const empId = parseInt(empleado.id_Usuario || empleado.Id || empleado.id);
            const empNombres = empleado.Nombres || '';
            const empApellido = empleado.PrimerApellido || '';

            const div = crearElementoEmpleado(empId, empNombres, empApellido, true, true);
            empleadosList.appendChild(div);
            empleadosMostrados++;

            empleadosSeleccionados.push(empId);
        });

        todosLosEmpleados.forEach(empleado => {
            const empId = parseInt(empleado.id_Usuario || empleado.Id || empleado.id);

            if (idsYaAsignados.includes(empId)) return;

            let tieneOtraTareaActiva = false;
            for (const [tareaId, empleadosAsignadosEnTarea] of Object.entries(empleadosAsignados)) {
                if (parseInt(tareaId) === tareaSeleccionada) continue;

                const estaEnOtraTarea = empleadosAsignadosEnTarea.some(emp => {
                    const idEmp = parseInt(emp.id_Usuario || emp.Id || emp.id);
                    return idEmp === empId;
                });

                if (estaEnOtraTarea) {
                    tieneOtraTareaActiva = true;
                    break;
                }
            }

            if (tieneOtraTareaActiva) return;

            const empNombres = empleado.Nombres || '';
            const empApellido = empleado.PrimerApellido || '';

            const div = crearElementoEmpleado(empId, empNombres, empApellido, false, false);
            empleadosList.appendChild(div);
            empleadosMostrados++;
        });

        if (empleadosMostrados === 0) {
            empleadosList.style.display = 'none';
            noEmpleadosMessage.textContent = 'No hay empleados disponibles para esta tarea';
            noEmpleadosMessage.style.display = 'block';
        } else {
            empleadosList.style.display = 'block';
            noEmpleadosMessage.style.display = 'none';
        }

        actualizarContador();
        document.getElementById('empleadosIdsInput').value = JSON.stringify(empleadosSeleccionados);

        const btnAsignar = document.getElementById('btnAsignar');
        if (tareaSeleccionada) {
            btnAsignar.disabled = false;
        } else {
            btnAsignar.disabled = true;
        }
    }

    function crearElementoEmpleado(empId, nombres, apellido, yaAsignado, checked) {
        const div = document.createElement('div');
        div.className = 'empleado-checkbox';
        div.setAttribute('data-id', empId);
        div.setAttribute('data-nombre', `${nombres} ${apellido}`.toLowerCase());

        if (yaAsignado) {
            div.style.backgroundColor = '#1a2e20'; 
            div.style.borderLeft = '4px solid #4CAF50';
        }

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `emp_${empId}`;
        checkbox.value = empId;
        checkbox.checked = checked;

        checkbox.addEventListener('change', function() {
            toggleEmpleado(empId);
        });

        const label = document.createElement('label');
        label.htmlFor = `emp_${empId}`;
        label.style.cursor = 'pointer';
        label.style.flex = '1';
        label.style.margin = '0';
        label.style.color = '#e0e0e0';

        if (yaAsignado) {
            const badge = document.createElement('span');
            badge.className = 'badge-activo';
            badge.textContent = 'Ya asignado';
            badge.style.marginLeft = '10px';

            const nameSpan = document.createElement('span');
            nameSpan.textContent = `${nombres} ${apellido}`;

            label.appendChild(nameSpan);
            label.appendChild(badge);
        } else {
            label.textContent = `${nombres} ${apellido}`;
        }

        div.appendChild(checkbox);
        div.appendChild(label);

        return div;
    }

    const empleadoSearch = document.getElementById('empleadoSearch');

    empleadoSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        const empleadoCheckboxes = document.querySelectorAll('.empleado-checkbox');

        empleadoCheckboxes.forEach(checkbox => {
            const nombre = checkbox.getAttribute('data-nombre');
            if (nombre.includes(searchTerm) || searchTerm === '') {
                checkbox.classList.remove('hidden');
            } else {
                checkbox.classList.add('hidden');
            }
        });
    });

    function toggleEmpleado(idEmpleado) {
        idEmpleado = parseInt(idEmpleado);

        const checkbox = document.getElementById(`emp_${idEmpleado}`);
        if (!checkbox) return;

        const index = empleadosSeleccionados.findIndex(id => parseInt(id) === idEmpleado);

        if (checkbox.checked && index === -1) {
            empleadosSeleccionados.push(idEmpleado);
        } else if (!checkbox.checked && index > -1) {
            empleadosSeleccionados.splice(index, 1);
        }

        const parent = checkbox.closest('.empleado-checkbox');
        if (parent) {
            if (checkbox.checked) {
                parent.style.backgroundColor = '#363645';
                parent.style.borderLeft = '4px solid var(--accent-orange)';
            } else {
                parent.style.backgroundColor = '#1a1a20';
                parent.style.borderLeft = 'none';
            }
            agregarEfectoSeleccion(parent);
        }

        actualizarContador();
        document.getElementById('empleadosIdsInput').value = JSON.stringify(empleadosSeleccionados);

        if (tareaSeleccionada) {
            document.getElementById('btnAsignar').disabled = false;
        }
    }

    function actualizarContador() {
        document.getElementById('empleadosSeleccionadosCounter').textContent =
            `${empleadosSeleccionados.length} empleado(s) seleccionado(s)`;

        actualizarTablaEmpleados();
    }

    function actualizarTablaEmpleados() {
        const tabla = document.getElementById('tablaEmpleadosSeleccionados');
        const tbody = document.getElementById('tablaEmpleadosBody');
        const totalCell = document.getElementById('totalEmpleadosTabla');

        tbody.innerHTML = '';

        if (empleadosSeleccionados.length === 0) {
            tabla.style.display = 'none';
            return;
        }

        tabla.style.display = 'block';

        empleadosSeleccionados.forEach((empId, index) => {
            let empleado = todosLosEmpleados.find(e =>
                parseInt(e.id_Usuario || e.Id || e.id) === parseInt(empId)
            );

            if (!empleado && empleadosAsignados[tareaSeleccionada]) {
                empleado = empleadosAsignados[tareaSeleccionada].find(e =>
                    parseInt(e.id_Usuario || e.Id || e.id) === parseInt(empId)
                );
            }

            const nombres = empleado?.Nombres || empleado?.nombres || 'N/A';
            const apellido = empleado?.PrimerApellido || empleado?.primerApellido || '';
            const email = empleado?.Email || empleado?.email || 'Sin email';

            const tr = document.createElement('tr');
            tr.id = `fila_emp_${empId}`;
            tr.innerHTML = `
                <td style="text-align: center; font-weight: bold;">${index + 1}</td>
                <td>${nombres} ${apellido}</td>
                <td style="color: #888;">${email}</td>
                <td class="text-center">
                    <button type="button" class="btn-quitar-empleado" onclick="quitarEmpleadoDeTabla(${empId})" title="Quitar empleado">
                        &times;
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        totalCell.textContent = empleadosSeleccionados.length;
    }

    function quitarEmpleadoDeTabla(empId) {
        empId = parseInt(empId);

        const checkbox = document.getElementById(`emp_${empId}`);
        if (checkbox) {
            checkbox.checked = false;

            const parent = checkbox.closest('.empleado-checkbox');
            if (parent) {
                parent.style.backgroundColor = '#1a1a20';
                parent.style.borderLeft = 'none';
            }
        }

        const index = empleadosSeleccionados.findIndex(id => parseInt(id) === empId);
        if (index > -1) {
            empleadosSeleccionados.splice(index, 1);
        }

        actualizarContador();
        document.getElementById('empleadosIdsInput').value = JSON.stringify(empleadosSeleccionados);

        const fila = document.getElementById(`fila_emp_${empId}`);
        if (fila) {
            fila.style.transition = 'all 0.3s ease';
            fila.style.opacity = '0';
            fila.style.transform = 'translateX(-20px)';
            setTimeout(() => {
                actualizarTablaEmpleados();
            }, 300);
        }

        mostrarNotificacion('Empleado removido de la lista', 'warning');
    }

    function cargarInformacionTarea(idTarea) {
        const infoContent = document.getElementById('infoTareaContent');

        const tarea = todasLasTareas.find(t => t.idTarea === idTarea);

        if (!tarea) {
            infoContent.innerHTML = '<p class="text-muted">No se pudo cargar la información</p>';
            return;
        }

        const asignados = empleadosAsignados[idTarea] || [];
        const tareaStatus = tarea.status;
        const tareaPrioridad = tarea.prioridad;

        let html = `
            <div class="mb-3 d-flex justify-content-between align-items-center">
                 <span class="text-muted">Estado:</span>
                 <span class="badge-activo" style="background:#444; color:white;">${tareaStatus}</span>
            </div>
            <div class="mb-3 d-flex justify-content-between align-items-center">
                 <span class="text-muted">Prioridad:</span>
                 <span style="color:var(--accent-gold); font-weight:bold;">${tareaPrioridad}</span>
            </div>
            <div class="mb-3 d-flex justify-content-between align-items-center">
                 <span class="text-muted">Total asignados:</span>
                 <span style="font-weight:bold; color:white;">${asignados.length}</span>
            </div>
            <div style="border-top:1px solid #333; margin:10px 0;"></div>
        `;

        if (asignados.length > 0) {
            html += '<div class="mb-2 text-muted small">Empleados asignados actualmente:</div>';
            asignados.forEach(emp => {
                const empNombres = emp.Nombres || emp.nombres || '';
                const empApellido = emp.PrimerApellido || emp.primerApellido || '';

                html += `
                    <div class="empleado-item empleado-activo">
                        <span>${empNombres} ${empApellido}</span>
                        <span class="badge-activo">Activo</span>
                    </div>
                `;
            });
        } else {
             html += `<div class="text-center text-muted fst-italic py-2">Sin empleados asignados.</div>`;
        }

        infoContent.innerHTML = html;
    }

    function generarReporteCompletoPDF() {
        mostrarNotificacion('Generando reporte completo PDF...', 'info');
        window.location.href = '/Tareas/Gestionar?handler=GenerarReporteCompleto&formato=pdf';
        setTimeout(() => { mostrarNotificacion('Reporte completo PDF descargado', 'success'); }, 1500);
    }

    function generarReporteCompletoExcel() {
        mostrarNotificacion('Generando reporte completo Excel...', 'info');
        window.location.href = '/Tareas/Gestionar?handler=GenerarReporteCompleto&formato=excel';
        setTimeout(() => { mostrarNotificacion('Reporte completo Excel descargado', 'success'); }, 1500);
    }

    document.getElementById('asignarForm').onsubmit = function(e) {
        if (!tareaSeleccionada) {
            e.preventDefault();
            mostrarNotificacion('⚠ Debes seleccionar una tarea', 'warning');
            return false;
        }

        if (empleadosSeleccionados.length === 0) {
            mostrarNotificacion('📤 Desasignando todos los empleados de la tarea...', 'info');
        } else {
            mostrarNotificacion(`💾 Guardando ${empleadosSeleccionados.length} empleado(s)...`, 'info');
        }

        const btnAsignar = document.getElementById('btnAsignar');
        btnAsignar.classList.add('loading');
        btnAsignar.disabled = true;

        return true;
    };

    function mostrarNotificacion(mensaje, tipo = 'info') {
        const colores = {
            'success': { bg: 'linear-gradient(135deg, #134E5E, #71B280)', icon: '✔' },
            'error': { bg: 'linear-gradient(135deg, #cb2d3e, #ef473a)', icon: '✖' },
            'warning': { bg: 'linear-gradient(135deg, #ff9966, #ff5e62)', icon: '⚠' },
            'info': { bg: 'linear-gradient(135deg, #2196F3, #1976D2)', icon: 'ℹ' }
        };

        const config = colores[tipo] || colores.info;

        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${config.bg};
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 9999;
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
            font-weight: 500;
        `;
        notification.innerHTML = `${config.icon} ${mensaje}`;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    const style = document.createElement('style');
    style.textContent = `
        @@keyframes slideInRight { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @@keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(400px); opacity: 0; } }
    `;
    document.head.appendChild(style);

    function agregarEfectoSeleccion(elemento) {
        elemento.style.transition = 'all 0.3s ease';
        elemento.style.transform = 'scale(1.02)';
        setTimeout(() => {
            elemento.style.transform = 'scale(1)';
        }, 300);
    }

    document.addEventListener('DOMContentLoaded', function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }, 5000);
        });

        const storedTarea = sessionStorage.getItem('tareaSeleccionada');
        const storedTitulo = sessionStorage.getItem('tareaTitulo');
        if (storedTarea && storedTitulo) {
            tareaSeleccionada = parseInt(storedTarea);
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.proyecto-option').forEach(option => {
            option.addEventListener('click', function() {
                agregarEfectoSeleccion(this);
            });
        });
    });

    </script>
}